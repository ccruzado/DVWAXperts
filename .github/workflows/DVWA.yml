name: DVWA

on: 
  workflow_dispatch:

jobs:
  
  DVWA:
    name: DVWA
    runs-on: ubuntu-latest
    env: 
      IMAGE_REPO_NAME: "dvwapub"
      IMAGE_TAG: "student"
      REPOSITORY_URI: "public.ecr.aws/o9e7c4k1/dvwapub"
      AWS_DEFAULT_REGION: "us-east-1"
      AWS_ACCESS_KEY_ID:  ${{secrets.AWS_ACCESS_KEY_ID}}
      AWS_SECRET_ACCESS_KEY:  ${{secrets.AWS_SECRET_ACCESS_KEY}}          

    steps:

    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Logging into AWS ECR
      run: |
        aws ecr-public get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${REPOSITORY_URI} 

    - name: Generate build number
      uses: einaregilsson/build-number@v3
      with:
        token: ${{secrets.github_token}} 

    - name: Building image
      run: |
        docker build . -t "${IMAGE_REPO_NAME}:${IMAGE_TAG}-$BUILD_NUMBER" 

    - name: Pushing to ECR
      run: |
        docker tag ${IMAGE_REPO_NAME}:${IMAGE_TAG}-$BUILD_NUMBER ${REPOSITORY_URI}:$IMAGE_TAG-$BUILD_NUMBER
        docker push ${REPOSITORY_URI}:${IMAGE_TAG}-$BUILD_NUMBER

    - name: Deploy
      run: |
        sed -i "s/<TAG>/${IMAGE_TAG}-$BUILD_NUMBER/" deployment.yml
        aws eks --region ${AWS_DEFAULT_REGION} update-kubeconfig --name eks-ccruzado
        kubectl apply -f deployment.yml